{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>ูุฑุงุด ฺฉูุงุณ</title>
    <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
</head>
<body>

<header>
    <h1>ูุฑุงุด ฺฉูุงุณ</h1>
    <button class="btn-back"
            onclick="window.location.href=`/dashboard/${window.location.pathname.split('/')[2]}/`">
        ุจุงุฒฺฏุดุช ุจู ุฏุงุดุจูุฑุฏ
    </button>
</header>

<div class="form-container">
    <form id="edit-class-form" class="form-grid">
        <label>ูุงู ฺฉูุงุณ:</label>
        <input type="text" id="name" required>

        <label>ูพุงู ุชุญุตู:</label>
        <select id="grade" required>
            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ...</option>
        </select>

        <label>ุชูุถุญุงุช:</label>
        <textarea id="description"></textarea>

        <!-- ุงู ููุฏ ุงุณุชุงุฏ ููุท ุจุฑุง ูุฏุฑุงู ููุงุด ุฏุงุฏู ูโุดูุฏ -->
        <div id="teacher-field">
            <label>ุงุณุชุงุฏ:</label>
            <select id="teacher_id" required>
                <option value="">ุงูุชุฎุงุจ ฺฉูุฏ...</option>
            </select>
        </div>

        <button type="submit" class="btn-primary">๐พ ุฐุฎุฑู ุชุบุฑุงุช</button>
    </form>

    <button id="delete-btn" class="btn-danger full-width" style="margin-top: 20px;">
        ๐๏ธ ุญุฐู ฺฉูุงุณ
    </button>

    <p id="message"></p>
</div>

<script>
    const token = localStorage.getItem('token');
    const userType = window.location.pathname.split('/')[2];
    const classroomId = window.location.pathname.split('/').filter(Boolean).slice(-2, -1)[0];
    const API_URL = `http://localhost:8000/api/exam/classrooms/${classroomId}/`;

    const nameInput = document.getElementById("name");
    const gradeInput = document.getElementById("grade");
    const descriptionInput = document.getElementById("description");
    const teacherField = document.getElementById("teacher-field");
    const teacherIdInput = document.getElementById("teacher_id");
    const messageEl = document.getElementById("message");

    const GRADE_CHOICES = [
        ['first_grade', 'ุงูู ุฏุจุณุชุงู'],
        ['second_grade', 'ุฏูู ุฏุจุณุชุงู'],
        ['third_grade', 'ุณูู ุฏุจุณุชุงู'],
        ['fourth_grade', 'ฺูุงุฑู ุฏุจุณุชุงู'],
        ['fifth_grade', 'ูพูุฌู ุฏุจุณุชุงู'],
        ['sixth_grade', 'ุดุดู ุฏุจุณุชุงู'],

        ['seventh_grade', 'ููุชู ูุชูุณุทู ุงูู'],
        ['eighth_grade', 'ูุดุชู ูุชูุณุทู ุงูู'],
        ['ninth_grade', 'ููู ูุชูุณุทู ุงูู'],

        ['tenth_grade', 'ุฏูู ูุชูุณุทู ุฏูู'],
        ['eleventh_grade', 'ุงุฒุฏูู ูุชูุณุทู ุฏูู'],
        ['twelfth_grade', 'ุฏูุงุฒุฏูู ูุชูุณุทู ุฏูู'],

        ['bachelor', 'ฺฉุงุฑุดูุงุณ'],
        ['master', 'ฺฉุงุฑุดูุงุณ ุงุฑุดุฏ'],
        ['phd', 'ุฏฺฉุชุฑุง'],
    ];

    // ุงฺฏุฑ ููุด ุงุณุชุงุฏ ุจุงุดุฏ ููุฏ ุงุณุชุงุฏ ุฑุง ุญุฐู ูโฺฉูู
    if (userType === 'teacher') {
        teacherField.style.display = 'none';
    }

    function loadGrades(currentGrade) {
        GRADE_CHOICES.forEach(([value, label]) => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = label;
            if (currentGrade === value) option.selected = true;
            gradeInput.appendChild(option);
        });
    }

    async function loadTeachers() {
        if (userRole === 'teacher') return; // ุงุณุชุงุฏ ูุจุงุฏ ุจุชูุงูุฏ ุงุณุชุงุฏ ุฏฺฏุฑ ุงูุชุฎุงุจ ฺฉูุฏ
        try {
            const res = await fetch("http://localhost:8000/api/core/teachers/", {
                headers: { "Authorization": `Token ${token}` }
            });
            if (!res.ok) throw new Error("ุฎุทุง ุฏุฑ ุฏุฑุงูุช ูุณุช ุงุณุชุงุฏูุง");

            const teachers = await res.json();
            teachers.forEach(teacher => {
                const option = document.createElement("option");
                option.value = teacher.id;
                option.textContent = `${teacher.account.first_name} ${teacher.account.last_name} - ${teacher.expertise || ""}`;
                teacherIdInput.appendChild(option);
            });
        } catch (err) {
            console.error(err);
        }
    }

    async function loadClassroom() {
        try {
            const res = await fetch(API_URL, {
                headers: { "Authorization": `Token ${token}` }
            });
            if (!res.ok) throw new Error("ุฎุทุง ุฏุฑ ุฏุฑุงูุช ุงุทูุงุนุงุช ฺฉูุงุณ");
            const data = await res.json();

            nameInput.value = data.name || "";
            descriptionInput.value = data.description || "";

            if (userRole !== 'teacher') {
                teacherIdInput.value = data.teacher?.id || "";
            }

            loadGrades(data.grade || "");
        } catch (err) {
            messageEl.textContent = err.message;
            messageEl.style.color = "red";
        }
    }

    document.getElementById("edit-class-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
            const body = {
                name: nameInput.value,
                grade: gradeInput.value,
                description: descriptionInput.value
            };

            if (userRole !== 'teacher') {
                body.teacher_id = teacherIdInput.value ? parseInt(teacherIdInput.value) : null;
            }

            const res = await fetch(API_URL, {
                method: "PUT",
                headers: {
                    "Authorization": `Token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const errData = await res.json();
                throw new Error(JSON.stringify(errData));
            }

            messageEl.textContent = "ุชุบุฑุงุช ุจุง ููููุช ุฐุฎุฑู ุดุฏ.";
            messageEl.style.color = "green";
        } catch (err) {
            messageEl.textContent = err.message;
            messageEl.style.color = "red";
        }
    });

    document.getElementById("delete-btn").addEventListener("click", async () => {
        if (!confirm("ุขุง ูุทูุฆู ูุณุชุฏ ฺฉู ูโุฎูุงูุฏ ุงู ฺฉูุงุณ ุฑุง ุญุฐู ฺฉูุฏุ")) return;
        try {
            const res = await fetch(API_URL, {
                method: "DELETE",
                headers: { "Authorization": `Token ${token}` }
            });
            if (!res.ok) throw new Error("ุฎุทุง ุฏุฑ ุญุฐู ฺฉูุงุณ");

            alert("ฺฉูุงุณ ุจุง ููููุช ุญุฐู ุดุฏ.");
            window.location.href = `/dashboard/${window.location.pathname.split('/')[2]}/`;
        } catch (err) {
            messageEl.textContent = err.message;
            messageEl.style.color = "red";
        }
    });

    loadTeachers().then(() => loadClassroom());
</script>

</body>
</html>
