{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„Ø§Ø³</title>
    <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
</head>
<body>

  <header>
    <h1>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„Ø§Ø³</h1>
        <button class="btn-back" onclick="window.location.href='/dashboard/institute/'">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
  </header>

    <div class="top-buttons">
    <a id="edit-class-btn" class="btn-primary" href="#">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù„Ø§Ø³</a>
    <a id="add-exam-btn"
       class="btn-primary"
       href="/dashboard/institute/classes/{{ class.id }}/exams/add/">
        â• Ø§ÙØ²ÙˆØ¯Ù† Ø¢Ø²Ù…ÙˆÙ†
    </a>
    <a id="view-students-btn" class="btn-primary">ğŸ‘¥ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</a>
</div>

<section class="filters">
    <div class="filter-group">
        <input type="text" id="title-filter" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†" class="form-input" />
        <input type="text" id="description-filter" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªÙˆØ¶ÛŒØ­Ø§Øª" class="form-input" />
        <select id="status-filter" class="form-input">
            <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
            <option value="true">ÙØ¹Ø§Ù„</option>
            <option value="false">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
        </select>
        <label for="start_time-filter">Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ (Ø§Ø²):</label>
        <input type="datetime-local" id="start_time-filter" class="form-input" placeholder="Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ (Ø§Ø²)" />

        <label for="end_time-filter">Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† (ØªØ§):</label>
        <input type="datetime-local" id="end_time-filter" class="form-input" placeholder="Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† (ØªØ§)" />
        <input type="number" id="duration_minutes-filter" min="0" placeholder="Ù…Ø¯Øª Ø²Ù…Ø§Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡)" class="form-input" />
        <input type="text" id="category_name-filter" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ" class="form-input" />
        <input type="text" id="creator_first_name-filter" placeholder="Ù†Ø§Ù… Ø³Ø§Ø²Ù†Ø¯Ù‡" class="form-input" />
        <input type="text" id="creator_last_name-filter" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø³Ø§Ø²Ù†Ø¯Ù‡" class="form-input" />
        <select id="ordering" class="form-input">
            <option value="start_time">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ â†‘</option>
            <option value="-start_time">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ â†“</option>
            <option value="title">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† â†‘</option>
            <option value="-title">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† â†“</option>
            <option value="duration_minutes">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¯Øª Ø²Ù…Ø§Ù† â†‘</option>
            <option value="-duration_minutes">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¯Øª Ø²Ù…Ø§Ù† â†“</option>
        </select>
        <button id="filter-btn" class="btn-primary">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
    </div>
</section>

<section class="exam-list" id="exam-list">
    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§...</p>
</section>

<script>
    const token = localStorage.getItem('token');
    const classroomId = window.location.pathname.split('/').filter(Boolean).pop();
    const BASE_API_URL = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/`;

    document.getElementById("edit-class-btn").href = `/dashboard/institute/classes/${classroomId}/edit/`;
    document.getElementById("add-exam-btn").href = `/dashboard/institute/classes/${classroomId}/exams/add/`;
    document.getElementById("view-students-btn").href = `/dashboard/institute/classes/${classroomId}/students/`;

    function buildApiUrl() {
        const params = new URLSearchParams();

        const title = document.getElementById("title-filter").value.trim();
        const description = document.getElementById("description-filter").value.trim();
        const status = document.getElementById("status-filter").value;
        const start_time = document.getElementById("start_time-filter").value;
        const end_time = document.getElementById("end_time-filter").value;
        const duration = document.getElementById("duration_minutes-filter").value.trim();
        const category_name = document.getElementById("category_name-filter").value.trim();
        const creator_first_name = document.getElementById("creator_first_name-filter").value.trim();
        const creator_last_name = document.getElementById("creator_last_name-filter").value.trim();
        const ordering = document.getElementById("ordering").value;

        if(title) params.append('title', title);
        if(description) params.append('description', description);
        if(status) params.append('status', status);
        if(start_time) params.append('start_time', new Date(start_time).toISOString());
        if(end_time) params.append('end_time', new Date(end_time).toISOString());
        if(duration) params.append('duration_minutes', duration);
        if(category_name) params.append('category_name', category_name);
        if(creator_first_name) params.append('creator_first_name', creator_first_name);
        if(creator_last_name) params.append('creator_last_name', creator_last_name);
        if(ordering) params.append('ordering', ordering);

        return BASE_API_URL + '?' + params.toString();
    }

    async function loadExams() {
        try {
            const url = buildApiUrl();
            const response = await fetch(url, {
                headers: {
                    "Authorization": `Token ${token}`
                }
            });

            if (!response.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§");

            const data = await response.json();
            const container = document.getElementById("exam-list");
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = "<p>Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>";
                return;
            }
        data.forEach(exam => {
            const div = document.createElement("div");
            div.className = "exam-card clickable-card";
            div.innerHTML = `
                <h3>${exam.title}</h3>
                <p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${exam.description || "-"}</p>
                <p><strong>Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹:</strong> ${new Date(exam.start_time).toLocaleString('fa-IR')}</p>
                <p><strong>Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†:</strong> ${new Date(exam.end_time).toLocaleString('fa-IR')}</p>
                <p><strong>Ù…Ø¯Øª Ø²Ù…Ø§Ù†:</strong> ${exam.duration_minutes} Ø¯Ù‚ÛŒÙ‚Ù‡</p>
                <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> ${exam.status ? "ÙØ¹Ø§Ù„" : "ØºÛŒØ±ÙØ¹Ø§Ù„"}</p>
            `;

            div.addEventListener("click", () => {
                window.location.href = `/dashboard/institute/classes/${classroomId}/exams/${exam.id}/questions/`;
            });

            container.appendChild(div);
        });

        } catch (error) {
            document.getElementById("exam-list").innerHTML = `<p style="color:red;">${error.message}</p>`;
        }
    }

    document.getElementById("filter-btn").addEventListener("click", e => {
        e.preventDefault();
        loadExams();
    });

    loadExams();
</script>
</body>
</html>
