{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ù‡ Ú©Ù„Ø§Ø³</title>
    <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
</head>
<body>

<header>
    <h1>Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ù‡ Ú©Ù„Ø§Ø³</h1>
    <button class="btn-back" id="back-btn">ğŸ”™ Ø¨Ø±Ú¯Ø´Øª</button>
</header>

<!-- Ø¨Ø®Ø´ ÙÛŒÙ„ØªØ± Ø¨Ø§ Ø§Ø³ØªØ§ÛŒÙ„ Ù‚Ø¨Ù„ÛŒ -->
<section class="filters">
    <div class="filter-group">
        <input type="text" id="search-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…ØŒ Ø§ÛŒÙ…ÛŒÙ„ØŒ Ú©Ø¯Ù…Ù„ÛŒ..." class="form-input" />
        <input type="text" id="filter-national-code" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" class="form-input" />
        <input type="text" id="filter-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="form-input" />
        <select id="filter-gender" class="form-input">
            <option value="">Ù‡Ù…Ù‡ Ø¬Ù†Ø³ÛŒØªâ€ŒÙ‡Ø§</option>
            <option value="male">Ù¾Ø³Ø±</option>
            <option value="female">Ø¯Ø®ØªØ±</option>
        </select>
        <select id="ordering-filter" class="form-input">
            <option value="">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ</option>
            <option value="-created_at">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
            <option value="created_at">Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†</option>
            <option value="date_of_birth">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ â†‘</option>
            <option value="-date_of_birth">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ â†“</option>
            <option value="account__first_name">Ù†Ø§Ù… â†‘</option>
            <option value="-account__first_name">Ù†Ø§Ù… â†“</option>
        </select>
        <button id="apply-filters" class="btn-primary">ÙÛŒÙ„ØªØ±</button>
    </div>
</section>

<section class="student-list" id="student-list">
    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†...</p>
</section>

<!-- div Ù…Ø®ØµÙˆØµ Ø®Ø·Ø§Ù‡Ø§ -->
<div id="error-message" style="color:red; margin:10px 0;"></div>

<script>
const token = localStorage.getItem('token');
const classroomId = window.location.pathname.split('/').filter(Boolean).slice(-3, -2)[0];
const STUDENT_LIST_API = "http://localhost:8000/api/core/students/";
const ADD_STUDENT_API = "http://localhost:8000/api/exam/students-classrooms/";

document.getElementById("back-btn").addEventListener("click", () => {
    window.location.href = `/dashboard/institute/classes/${classroomId}/students/`;
});

async function loadAllStudents() {
    const errorDiv = document.getElementById("error-message");
    errorDiv.textContent = ""; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    try {
        const search = document.getElementById("search-input").value.trim();
        const nationalCode = document.getElementById("filter-national-code").value.trim();
        const phone = document.getElementById("filter-phone").value.trim();
        const gender = document.getElementById("filter-gender").value;
        const ordering = document.getElementById("ordering-filter").value;

        const params = new URLSearchParams();
        if (search) params.append("search", search);
        if (nationalCode) params.append("national_code", nationalCode);
        if (phone) params.append("phone_number", phone);
        if (gender) params.append("gender", gender);
        if (ordering) params.append("ordering", ordering);

        const res = await fetch(`${STUDENT_LIST_API}?${params.toString()}`, {
            headers: { "Authorization": `Token ${token}` }
        });

        if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.detail || "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†");
        }

        const students = await res.json();
        const container = document.getElementById("student-list");
        container.innerHTML = "";

        if (students.length === 0) {
            container.innerHTML = "<p>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>";
            return;
        }

        students.forEach(student => {
            const div = document.createElement("div");
            div.className = "student-card";

            div.innerHTML = `
                <span class="student-name">
                    ${student.account.first_name} ${student.account.last_name}
                </span>
                <button class="btn-primary">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
            `;

            div.querySelector("button").addEventListener("click", async () => {
                if (!confirm(`Ø¢ÛŒØ§ ${student.account.first_name} Ø±Ø§ Ø¨Ù‡ Ú©Ù„Ø§Ø³ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ`)) return;

                try {
                    const addRes = await fetch(ADD_STUDENT_API, {
                        method: "POST",
                        headers: {
                            "Authorization": `Token ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            classroom_id: classroomId,
                            student_id: student.id
                        })
                    });

                    if (!addRes.ok) {
                        const errData = await addRes.json();
                        throw new Error(errData.detail || "Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ù‡ Ú©Ù„Ø§Ø³");
                    }

                    alert("âœ… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯");
                    loadAllStudents();
                } catch (err) {
                    errorDiv.textContent = err.message;
                }
            });

            container.appendChild(div);
        });

    } catch (err) {
        errorDiv.textContent = err.message;
        document.getElementById("student-list").innerHTML = "";
    }
}

document.getElementById("apply-filters").addEventListener("click", () => {
    loadAllStudents();
});

loadAllStudents();
</script>


</body>
</html>
