{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ویرایش سوال</title>
  <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}">
  <style>
    .option-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 8px 0;
    }
    .option-item input[type="text"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
    }
    .option-item label {
        display: flex;
        align-items: center;
        gap: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>✏️ ویرایش سوال</h1>
    <button class="btn-back" onclick="window.history.back()">⬅️ بازگشت</button>
  </header>

  <form id="question-form" class="form-container">
    <label>متن سوال</label>
    <textarea id="question-text" class="form-input"></textarea>

    <label>نوع سوال</label>
    <select id="question-type" class="form-input" disabled>
      <option value="MultipleChoice">چندگزینه‌ای</option>
      <option value="TrueFalse">درست/نادرست</option>
      <option value="Descriptive">تشریحی</option>
    </select>

    <label>نمره</label>
    <input type="number" id="question-score" class="form-input" />

    <!-- گزینه‌ها فقط برای تستی -->
    <div id="options-section" style="display:none;">
      <h3>گزینه‌ها</h3>
      <div id="options-list"></div>
      <button type="button" id="add-option-btn" class="btn-primary">➕ افزودن گزینه</button>
    </div>

    <button type="submit" class="btn-primary">💾 ذخیره تغییرات</button>
  </form>

  <script>
    const token = localStorage.getItem("token");
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const classroomId = pathParts[pathParts.indexOf("classes") + 1];
    const examId = pathParts[pathParts.indexOf("exams") + 1];
    const questionId = pathParts[pathParts.indexOf("questions") + 1];

    const QUESTION_API = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/${questionId}/`;

    // لود سوال
    async function loadQuestion() {
      const resp = await fetch(QUESTION_API, { headers: { "Authorization": `Token ${token}` } });
      if (!resp.ok) return alert("خطا در دریافت سوال");
      const q = await resp.json();

      document.getElementById("question-text").value = q.text;
      document.getElementById("question-type").value = q.question_type;
      document.getElementById("question-score").value = q.score;

      if (q.question_type !== "Descriptive") {
        loadOptions();
      }
    }

    // لود گزینه‌ها
    async function loadOptions() {
      document.getElementById("options-section").style.display = "block";
      const resp = await fetch(`${QUESTION_API}options/`, { headers: { "Authorization": `Token ${token}` } });
      if (!resp.ok) return alert("خطا در دریافت گزینه‌ها");
      const options = await resp.json();

      const container = document.getElementById("options-list");
      container.innerHTML = "";
      options.forEach(opt => addOptionItem(opt.text, opt.is_correct, opt.id));
    }

    // ایجاد یک آیتم گزینه
    function addOptionItem(text = "", isCorrect = false, id = null) {
      const div = document.createElement("div");
      div.className = "option-item";
      div.innerHTML = `
        <input type="text" value="${text}" data-id="${id || ""}" class="form-input option-text" placeholder="متن گزینه" />
        <label>
          <input type="checkbox" ${isCorrect ? "checked" : ""} class="option-correct" />
          صحیح
        </label>
        <button type="button" class="btn-danger btn-remove-option">❌</button>
      `;

      // حذف گزینه
      div.querySelector(".btn-remove-option").addEventListener("click", async () => {
        const optionId = div.querySelector(".option-text").dataset.id;
        if (optionId) {
          const resp = await fetch(`${QUESTION_API}options/${optionId}/`, {
            method: "DELETE",
            headers: { "Authorization": `Token ${token}` }
          });
          if (!resp.ok) {
            alert("خطا در حذف گزینه");
            return;
          }
        }
        div.remove();
      });

      document.getElementById("options-list").appendChild(div);
    }

    // دکمه افزودن گزینه
    document.getElementById("add-option-btn").addEventListener("click", () => addOptionItem());

    // ذخیره تغییرات
    document.getElementById("question-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      // آپدیت خود سوال
      const body = {
        text: document.getElementById("question-text").value,
        score: document.getElementById("question-score").value,
        question_type: document.getElementById("question-type").value
      };

      const resp = await fetch(QUESTION_API, {
        method: "PUT",
        headers: { "Authorization": `Token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!resp.ok) return alert("خطا در ذخیره سوال");

      // گزینه‌ها
      if (body.question_type !== "Descriptive") {
        const optionItems = document.querySelectorAll(".option-item");
        for (let item of optionItems) {
          const id = item.querySelector(".option-text").dataset.id;
          const optionBody = {
            text: item.querySelector(".option-text").value,
            is_correct: item.querySelector(".option-correct").checked,
            question_id: questionId
          };

          if (id) {
            // آپدیت گزینه قدیمی
            await fetch(`${QUESTION_API}options/${id}/`, {
              method: "PUT",
              headers: { "Authorization": `Token ${token}`, "Content-Type": "application/json" },
              body: JSON.stringify(optionBody)
            });
          } else {
            // افزودن گزینه جدید
            await fetch(`${QUESTION_API}options/`, {
              method: "POST",
              headers: { "Authorization": `Token ${token}`, "Content-Type": "application/json" },
              body: JSON.stringify(optionBody)
            });
          }
        }
      }

      alert("تغییرات با موفقیت ذخیره شد ✅");
      window.history.back();
    });

    loadQuestion();
  </script>
</body>
</html>
