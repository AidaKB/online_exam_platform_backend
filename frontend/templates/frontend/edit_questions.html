{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙˆØ§Ù„</title>
  <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}">
  <style>
    .option-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 8px 0;
    }
    .option-item input[type="text"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
    }
    .option-item label {
        display: flex;
        align-items: center;
        gap: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙˆØ§Ù„</h1>
    <button class="btn-back" onclick="window.history.back()">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
  </header>

  <form id="question-form" class="form-container">
    <label>Ù…ØªÙ† Ø³ÙˆØ§Ù„</label>
    <textarea id="question-text" class="form-input"></textarea>

    <label>Ù†ÙˆØ¹ Ø³ÙˆØ§Ù„</label>
    <select id="question-type" class="form-input" disabled>
      <option value="MultipleChoice">Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ</option>
      <option value="TrueFalse">Ø¯Ø±Ø³Øª/Ù†Ø§Ø¯Ø±Ø³Øª</option>
      <option value="Descriptive">ØªØ´Ø±ÛŒØ­ÛŒ</option>
    </select>

    <label>Ù†Ù…Ø±Ù‡</label>
    <input type="number" id="question-score" class="form-input" />

    <!-- Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ³ØªÛŒ -->
    <div id="options-section" style="display:none;">
      <h3>Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3>
      <div id="options-list"></div>
      <button type="button" id="add-option-btn" class="btn-primary">â• Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø²ÛŒÙ†Ù‡</button>
    </div>

    <button type="submit" class="btn-primary">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
  </form>

  <script>
    const token = localStorage.getItem("token");
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const classroomId = pathParts[pathParts.indexOf("classes") + 1];
    const examId = pathParts[pathParts.indexOf("exams") + 1];
    const questionId = pathParts[pathParts.indexOf("questions") + 1];

    const QUESTION_API = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/${questionId}/`;

    // Ù„ÙˆØ¯ Ø³ÙˆØ§Ù„
    async function loadQuestion() {
      const resp = await fetch(QUESTION_API, { headers: { "Authorization": `Token ${token}` } });
      if (!resp.ok) return alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ§Ù„");
      const q = await resp.json();

      document.getElementById("question-text").value = q.text;
      document.getElementById("question-type").value = q.question_type;
      document.getElementById("question-score").value = q.score;

      if (q.question_type !== "Descriptive") {
        loadOptions();
      }
    }

    // Ù„ÙˆØ¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
    async function loadOptions() {
      document.getElementById("options-section").style.display = "block";
      const resp = await fetch(`${QUESTION_API}options/`, { headers: { "Authorization": `Token ${token}` } });
      if (!resp.ok) return alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§");
      const options = await resp.json();

      const container = document.getElementById("options-list");
      container.innerHTML = "";
      options.forEach(opt => addOptionItem(opt.text, opt.is_correct, opt.id));
    }

    // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø¢ÛŒØªÙ… Ú¯Ø²ÛŒÙ†Ù‡
    function addOptionItem(text = "", isCorrect = false, id = null) {
      const div = document.createElement("div");
      div.className = "option-item";
      div.innerHTML = `
        <input type="text" value="${text}" data-id="${id || ""}" class="form-input option-text" placeholder="Ù…ØªÙ† Ú¯Ø²ÛŒÙ†Ù‡" />
        <label>
          <input type="checkbox" ${isCorrect ? "checked" : ""} class="option-correct" />
          ØµØ­ÛŒØ­
        </label>
        <button type="button" class="btn-danger btn-remove-option">âŒ</button>
      `;

      // Ø­Ø°Ù Ú¯Ø²ÛŒÙ†Ù‡
      div.querySelector(".btn-remove-option").addEventListener("click", async () => {
        const optionId = div.querySelector(".option-text").dataset.id;
        if (optionId) {
          const resp = await fetch(`${QUESTION_API}options/${optionId}/`, {
            method: "DELETE",
            headers: { "Authorization": `Token ${token}` }
          });
          if (!resp.ok) {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú¯Ø²ÛŒÙ†Ù‡");
            return;
          }
        }
        div.remove();
      });

      document.getElementById("options-list").appendChild(div);
    }

    // Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø²ÛŒÙ†Ù‡
    document.getElementById("add-option-btn").addEventListener("click", () => addOptionItem());

    // Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
    document.getElementById("question-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      // Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯ Ø³ÙˆØ§Ù„
      const body = {
        text: document.getElementById("question-text").value,
        score: document.getElementById("question-score").value,
        question_type: document.getElementById("question-type").value
      };

      const resp = await fetch(QUESTION_API, {
        method: "PUT",
        headers: { "Authorization": `Token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!resp.ok) return alert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³ÙˆØ§Ù„");

      // Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
      if (body.question_type !== "Descriptive") {
        const optionItems = document.querySelectorAll(".option-item");
        for (let item of optionItems) {
          const id = item.querySelector(".option-text").dataset.id;
          const optionBody = {
            text: item.querySelector(".option-text").value,
            is_correct: item.querySelector(".option-correct").checked,
            question_id: questionId
          };

          if (id) {
            // Ø¢Ù¾Ø¯ÛŒØª Ú¯Ø²ÛŒÙ†Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒ
            await fetch(`${QUESTION_API}options/${id}/`, {
              method: "PUT",
              headers: { "Authorization": `Token ${token}`, "Content-Type": "application/json" },
              body: JSON.stringify(optionBody)
            });
          } else {
            // Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯
            await fetch(`${QUESTION_API}options/`, {
              method: "POST",
              headers: { "Authorization": `Token ${token}`, "Content-Type": "application/json" },
              body: JSON.stringify(optionBody)
            });
          }
        }
      }

      alert("ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…");
      window.history.back();
    });

    loadQuestion();
  </script>
</body>
</html>
