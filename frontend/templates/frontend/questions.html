{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¢Ø²Ù…ÙˆÙ†</title>
  <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
  <style>
    .answer-box {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      font-family: 'IRANSans', sans-serif;
      resize: vertical;
    }
    .send-answer-btn {
      margin-top: 8px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      background-color: #1E90FF;
      color: white;
      border: none;
      border-radius: 4px;
      font-family: 'IRANSans', sans-serif;
      transition: background-color 0.2s;
    }
    .send-answer-btn:hover {
      background-color: #187bcd;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="exam-title">Ù„ÛŒØ³Øª Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ†</h1>
    <button class="btn-back" onclick="window.history.back()">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
  </header>

  <div id="exam-status" style="text-align:center; font-size:18px; font-weight:bold; margin:15px;"></div>

  <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ -->
  <div class="top-buttons" id="exam-buttons">
    <button class="btn-primary" id="add-question-btn">â• Ø§ÙØ²ÙˆØ¯Ù† Ø³ÙˆØ§Ù„</button>
    <button class="btn-primary" id="edit-exam-btn">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ø²Ù…ÙˆÙ†</button>
    <button class="btn-primary" id="grade-questions-btn">ğŸ“ ØªØµØ­ÛŒØ­ Ø³ÙˆØ§Ù„Ø§Øª</button>
    <button class="btn-primary" id="exam-results-btn">ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†</button>
    <button class="btn-primary" id="exam-feedback-btn">ğŸ’¬ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†</button>
  </div>

  <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
  <section class="filters">
    <div class="filter-group">
      <input type="text" id="text-filter" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…ØªÙ† Ø³ÙˆØ§Ù„" class="form-input" />
      <select id="type-filter" class="form-input">
        <option value="">Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹ Ø³ÙˆØ§Ù„</option>
        <option value="MultipleChoice">Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ</option>
        <option value="TrueFalse">Ø¯Ø±Ø³Øª/Ù†Ø§Ø¯Ø±Ø³Øª</option>
        <option value="Descriptive">ØªØ´Ø±ÛŒØ­ÛŒ</option>
      </select>
      <input type="number" id="score-filter" min="0" placeholder="Ù†Ù…Ø±Ù‡" class="form-input" />
      <select id="ordering" class="form-input">
        <option value="text">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† â†‘</option>
        <option value="-text">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† â†“</option>
        <option value="question_type">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ â†‘</option>
        <option value="-question_type">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ â†“</option>
        <option value="score">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ù‡ â†‘</option>
        <option value="-score">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ù‡ â†“</option>
      </select>
      <button id="filter-btn" class="btn-primary">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
    </div>
  </section>

  <section id="multiple-choice-questions">
    <h2>Ø³ÙˆØ§Ù„Ø§Øª ØªØ³ØªÛŒ (Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ / Ø¯Ø±Ø³Øªâ€ŒÙ†Ø§Ø¯Ø±Ø³Øª)</h2>
    <div class="questions-container">
      <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ù„Ø§Øª...</p>
    </div>
  </section>

  <section id="descriptive-questions">
    <h2>Ø³ÙˆØ§Ù„Ø§Øª ØªØ´Ø±ÛŒØ­ÛŒ</h2>
    <div class="questions-container">
      <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ù„Ø§Øª...</p>
    </div>
  </section>

  <script>
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem('user_id')
    const userType = window.location.pathname.split('/')[2];
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const classroomId = pathParts[pathParts.indexOf("classes") + 1];
    const examId = pathParts[pathParts.indexOf("exams") + 1];

    const BASE_API_URL = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/`;
    const EXAM_API_URL = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/`;
    const EXAM_TIME_API = `http://localhost:8000/api/exam/exam-time/`;
    const USER_OPTIONS_API = `http://localhost:8000/api/exam/options-answers/`;
    const USER_ANSWERS_API = `http://localhost:8000/api/exam/answers/`;

    const QUESTION_TYPE_LABELS = {
      "MultipleChoice": "Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ",
      "Descriptive": "ØªØ´Ø±ÛŒØ­ÛŒ",
      "TrueFalse": "Ø¯Ø±Ø³Øª/Ù†Ø§Ø¯Ø±Ø³Øª"
    };

    const mcContainer = document.querySelector("#multiple-choice-questions .questions-container");
    const descContainer = document.querySelector("#descriptive-questions .questions-container");

    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ù…Ø®ÙÛŒ Ø¨Ø´Ù†
    if (userType === "student") {
      document.getElementById("add-question-btn").style.display = "none";
      document.getElementById("edit-exam-btn").style.display = "none";
      document.getElementById("grade-questions-btn").style.display = "none";
      document.getElementById("exam-feedback-btn").style.display = "none";
    }

    async function loadExamTitle() {
      try {
        const resp = await fetch(EXAM_API_URL, { headers: { "Authorization": `Token ${token}` } });
        if (!resp.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø²Ù…ÙˆÙ†");
        const exam = await resp.json();
        document.getElementById("exam-title").textContent = `Ù„ÛŒØ³Øª Ø³ÙˆØ§Ù„Ø§Øª ${exam.title}`;
        document.title = `Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ† - ${exam.title}`;
      } catch (err) {
        console.error(err);
      }
    }

    // Ø¯Ù‚ÛŒÙ‚Ø§ Ù‡Ù…Ø§Ù† Ù…Ù†Ø·Ù‚ Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ Ù†Ø³Ø®Ù‡ Ø§ÙˆÙ„
    async function checkStudentExam() {
      if (userType !== "student") return;
      try {
        const res = await fetch(EXAM_TIME_API, {
          method: "POST",
          headers: {
            "Authorization": `Token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ exam_id: examId })
        });
        const data = await res.json();
        const statusEl = document.getElementById("exam-status");

        if (data.detail) {
          alert(data.detail);
          window.history.back();
          return;
        }

        const finishTime = new Date(data.finish_time);
        const now = new Date();
        if (finishTime < now) {
          alert("â° Ø²Ù…Ø§Ù† Ø¢Ø²Ù…ÙˆÙ† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.");
          window.history.back();
          return;
        }

        function updateTimer() {
          const now = new Date();
          const diff = finishTime - now;
          if (diff <= 0) {
            clearInterval(timerInterval);
            alert("â° Ø²Ù…Ø§Ù† Ø¢Ø²Ù…ÙˆÙ† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯.");
            window.history.back();
            return;
          }
          const minutes = Math.floor((diff / 1000 / 60) % 60);
          const seconds = Math.floor((diff / 1000) % 60);
          statusEl.style.color = "#000";
          statusEl.textContent = `â³ Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ùˆ ${seconds} Ø«Ø§Ù†ÛŒÙ‡`;
        }

        updateTimer();
        const timerInterval = setInterval(updateTimer, 1000);

      } catch (err) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¢Ø²Ù…ÙˆÙ†:", err);
      }
    }

    function buildApiUrl() {
      const params = new URLSearchParams();
      const text = document.getElementById("text-filter").value.trim();
      const type = document.getElementById("type-filter").value;
      const score = document.getElementById("score-filter").value.trim();
      const ordering = document.getElementById("ordering").value;
      if (text) params.append("text", text);
      if (type) params.append("question_type", type);
      if (score) params.append("score", score);
      if (ordering) params.append("ordering", ordering);
      return BASE_API_URL + "?" + params.toString();
    }

    async function loadQuestions() {
      try {
        const url = buildApiUrl();
        const response = await fetch(url, { headers: { "Authorization": `Token ${token}` } });
        if (!response.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ§Ù„Ø§Øª");
        const data = await response.json();
        mcContainer.innerHTML = "";
        descContainer.innerHTML = "";

        if (data.length === 0) {
          mcContainer.innerHTML = "<p>Ø³ÙˆØ§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>";
          descContainer.innerHTML = "";
          return;
        }

        for (const q of data) {
          const div = document.createElement("div");
          div.className = "question-card";

          div.innerHTML = `
            <h3>${q.text}</h3>
            <p><strong>Ù†ÙˆØ¹ Ø³ÙˆØ§Ù„:</strong> ${QUESTION_TYPE_LABELS[q.question_type]}</p>
            <p><strong>Ù†Ù…Ø±Ù‡:</strong> ${q.score}</p>
          `;

          if (userType === "student") {
            if (q.question_type === "MultipleChoice" || q.question_type === "TrueFalse") {
              const optionsResponse = await fetch(
                `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/${q.id}/options/`,
                { headers: { "Authorization": `Token ${token}` } }
              );
              const options = await optionsResponse.json();
              const ul = document.createElement("ul");
              ul.className = "option-list";
              options.forEach(opt => {
                const li = document.createElement("li");
                const radio = document.createElement("input");
                radio.type = "radio";
                radio.name = `question-${q.id}`;
                radio.value = opt.id;
                li.appendChild(radio);
                li.appendChild(document.createTextNode(` ${opt.text}`));
                ul.appendChild(li);
              });
              div.appendChild(ul);

              const sendBtn = document.createElement("button");
              sendBtn.className = "send-answer-btn";
              sendBtn.textContent = "Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®";
              sendBtn.addEventListener("click", async () => {
                const selected = div.querySelector(`input[name="question-${q.id}"]:checked`);
                if (!selected) { alert("Ù„Ø·ÙØ§ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
                await fetch(USER_OPTIONS_API, {
                  method: "POST",
                  headers: { "Authorization": `Token ${token}`, "Content-Type": "application/json" },
                  body: JSON.stringify({question_id: q.id, answer_option_id: selected.value })
                });
                alert("Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ âœ…");
              });
              div.appendChild(sendBtn);
            } else if (q.question_type === "Descriptive") {
              const textarea = document.createElement("textarea");
              textarea.className = "answer-box";
              textarea.placeholder = "Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...";
              div.appendChild(textarea);

              const sendBtn = document.createElement("button");
              sendBtn.className = "send-answer-btn";
              sendBtn.textContent = "Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®";
              sendBtn.addEventListener("click", async () => {
                if (!textarea.value.trim()) { alert("Ù„Ø·ÙØ§ Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
                await fetch(USER_ANSWERS_API, {
                  method: "POST",
                  headers: { "Authorization": `Token ${token}`, "Content-Type": "application/json" },
                  body: JSON.stringify({question_id: q.id, answer_text: textarea.value })
                });
                alert("Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ âœ…");
              });
              div.appendChild(sendBtn);
            }
          } else {
            div.classList.add("clickable-card");
            div.innerHTML += `<button class="btn-danger btn-delete" data-id="${q.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>`;
            div.addEventListener("click", (e) => {
              if (e.target.classList.contains("btn-delete")) return;
              window.location.href = `/dashboard/${userType}/classes/${classroomId}/exams/${examId}/questions/${q.id}/edit/`;
            });

            if (q.question_type === "MultipleChoice" || q.question_type === "TrueFalse") {
              const optionsResponse = await fetch(
                `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/${q.id}/options/`,
                { headers: { "Authorization": `Token ${token}` } }
              );
              const options = await optionsResponse.json();
              const ul = document.createElement("ul");
              ul.className = "option-list";
              options.forEach(opt => {
                const li = document.createElement("li");
                li.innerHTML = `${opt.text} ${opt.is_correct ? "âœ…" : ""}`;
                ul.appendChild(li);
              });
              div.appendChild(ul);
            }
          }

          if (q.question_type === "Descriptive") descContainer.appendChild(div);
          else mcContainer.appendChild(div);
        }

        if (userType !== "student") {
          document.querySelectorAll(".btn-delete").forEach(btn => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const questionId = e.target.dataset.id;
              if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø³ÙˆØ§Ù„ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ")) return;
              const del = await fetch(
                `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/${questionId}/`,
                { method: "DELETE", headers: { "Authorization": `Token ${token}` } }
              );
              if (del.ok) loadQuestions();
              else alert("Ø­Ø°Ù Ø³ÙˆØ§Ù„ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯");
            });
          });
        }
      } catch (err) {
        mcContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
        descContainer.innerHTML = "";
      }
    }

    document.getElementById("filter-btn").addEventListener("click", e => {
      e.preventDefault();
      loadQuestions();
    });

    document.getElementById("exam-results-btn").addEventListener("click", () => {
      window.location.href = `/dashboard/${userType}/classes/${classroomId}/exams/${examId}/results/`;
    });
    if (userType !== "student") {
      document.getElementById("add-question-btn").addEventListener("click", () => {
        window.location.href = `/dashboard/${userType}/classes/${classroomId}/exams/${examId}/add-question/`;
      });
      document.getElementById("edit-exam-btn").addEventListener("click", () => {
        window.location.href = `/dashboard/${userType}/classes/${classroomId}/exams/${examId}/edit/`;
      });
      document.getElementById("grade-questions-btn").addEventListener("click", () => {
        window.location.href = `/dashboard/${userType}/classes/${classroomId}/exams/${examId}/grade/`;
      });
      document.getElementById("exam-feedback-btn").addEventListener("click", () => {
        window.location.href = `/dashboard/${userType}/classes/${classroomId}/exams/${examId}/feedback/`;
      });
    }

    loadExamTitle();
    checkStudentExam().then(() => loadQuestions());
  </script>
</body>
</html>
