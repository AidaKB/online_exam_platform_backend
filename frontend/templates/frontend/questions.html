{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ†</title>
  <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
</head>
<body>
  <header>
    <h1>Ù„ÛŒØ³Øª Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ†</h1>
    <button class="btn-back" onclick="window.history.back()">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
  </header>

  <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø¢Ø²Ù…ÙˆÙ† -->
  <div class="top-buttons">
    <button class="btn-primary" id="add-question-btn">â• Ø§ÙØ²ÙˆØ¯Ù† Ø³ÙˆØ§Ù„</button>
    <button class="btn-primary" id="edit-exam-btn">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ø²Ù…ÙˆÙ†</button>
    <button class="btn-primary" id="grade-questions-btn">ğŸ“ ØªØµØ­ÛŒØ­ Ø³ÙˆØ§Ù„Ø§Øª</button>
    <button class="btn-primary" id="exam-results-btn">ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†</button>
  </div>

  <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
  <section class="filters">
    <div class="filter-group">
      <input type="text" id="text-filter" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…ØªÙ† Ø³ÙˆØ§Ù„" class="form-input" />
      <select id="type-filter" class="form-input">
        <option value="">Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹ Ø³ÙˆØ§Ù„</option>
        <option value="MultipleChoice">Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ</option>
        <option value="TrueFalse">Ø¯Ø±Ø³Øª/Ù†Ø§Ø¯Ø±Ø³Øª</option>
        <option value="Descriptive">ØªØ´Ø±ÛŒØ­ÛŒ</option>
      </select>
      <input type="number" id="score-filter" min="0" placeholder="Ù†Ù…Ø±Ù‡" class="form-input" />
      <select id="ordering" class="form-input">
        <option value="text">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† â†‘</option>
        <option value="-text">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† â†“</option>
        <option value="question_type">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ â†‘</option>
        <option value="-question_type">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ â†“</option>
        <option value="score">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ù‡ â†‘</option>
        <option value="-score">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ù‡ â†“</option>
      </select>
      <button id="filter-btn" class="btn-primary">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
    </div>
  </section>

  <!-- Ø³ÙˆØ§Ù„Ø§Øª ØªØ³ØªÛŒ -->
  <section id="multiple-choice-questions">
    <h2>Ø³ÙˆØ§Ù„Ø§Øª ØªØ³ØªÛŒ (Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ / Ø¯Ø±Ø³Øªâ€ŒÙ†Ø§Ø¯Ø±Ø³Øª)</h2>
    <div class="questions-container">
      <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ù„Ø§Øª...</p>
    </div>
  </section>

  <!-- Ø³ÙˆØ§Ù„Ø§Øª ØªØ´Ø±ÛŒØ­ÛŒ -->
  <section id="descriptive-questions">
    <h2>Ø³ÙˆØ§Ù„Ø§Øª ØªØ´Ø±ÛŒØ­ÛŒ</h2>
    <div class="questions-container">
      <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ù„Ø§Øª...</p>
    </div>
  </section>

  <script>
    const token = localStorage.getItem("token");
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const classroomId = pathParts[pathParts.indexOf("classes") + 1];
    const examId = pathParts[pathParts.indexOf("exams") + 1];
    const BASE_API_URL = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/`;

    const QUESTION_TYPE_LABELS = {
      "MultipleChoice": "Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ",
      "Descriptive": "ØªØ´Ø±ÛŒØ­ÛŒ",
      "TrueFalse": "Ø¯Ø±Ø³Øª/Ù†Ø§Ø¯Ø±Ø³Øª"
    };

    const mcContainer = document.querySelector("#multiple-choice-questions .questions-container");
    const descContainer = document.querySelector("#descriptive-questions .questions-container");

    function buildApiUrl() {
      const params = new URLSearchParams();
      const text = document.getElementById("text-filter").value.trim();
      const type = document.getElementById("type-filter").value;
      const score = document.getElementById("score-filter").value.trim();
      const ordering = document.getElementById("ordering").value;

      if (text) params.append("text", text);
      if (type) params.append("question_type", type);
      if (score) params.append("score", score);
      if (ordering) params.append("ordering", ordering);

      return BASE_API_URL + "?" + params.toString();
    }

    async function loadQuestions() {
      try {
        const url = buildApiUrl();
        const response = await fetch(url, { headers: { "Authorization": `Token ${token}` } });
        if (!response.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ§Ù„Ø§Øª");

        const data = await response.json();
        mcContainer.innerHTML = "";
        descContainer.innerHTML = "";

        if (data.length === 0) {
          mcContainer.innerHTML = "<p>Ø³ÙˆØ§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>";
          descContainer.innerHTML = "";
          return;
        }

        for (const q of data) {
          const div = document.createElement("div");
          div.className = "question-card clickable-card";
          div.innerHTML = `
            <h3>${q.text}</h3>
            <p><strong>Ù†ÙˆØ¹ Ø³ÙˆØ§Ù„:</strong> ${QUESTION_TYPE_LABELS[q.question_type]}</p>
            <p><strong>Ù†Ù…Ø±Ù‡:</strong> ${q.score}</p>
            <button class="btn-danger btn-delete" data-id="${q.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          `;

          if (q.question_type === "MultipleChoice" || q.question_type === "TrueFalse") {
            const optionsResponse = await fetch(
              `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/${q.id}/options/`,
              { headers: { "Authorization": `Token ${token}` } }
            );
            const options = await optionsResponse.json();

            const ul = document.createElement("ul");
            ul.className = "option-list";
            options.forEach(opt => {
              const li = document.createElement("li");
              li.innerHTML = `${opt.text} ${opt.is_correct ? "âœ…" : ""}`;
              ul.appendChild(li);
            });
            div.appendChild(ul);
          }

          if (q.question_type === "Descriptive") {
            descContainer.appendChild(div);
          } else {
            mcContainer.appendChild(div);
          }
        }

        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù
        document.querySelectorAll(".btn-delete").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const questionId = e.target.dataset.id;
            if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø³ÙˆØ§Ù„ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ")) return;

            try {
              const deleteResp = await fetch(
                `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/${questionId}/`,
                { method: "DELETE", headers: { "Authorization": `Token ${token}` } }
              );
              if (!deleteResp.ok) throw new Error("Ø­Ø°Ù Ø³ÙˆØ§Ù„ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ù†Ø¨ÙˆØ¯");
              loadQuestions();
            } catch (err) {
              alert(err.message);
            }
          });
        });

      } catch (err) {
        mcContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
        descContainer.innerHTML = "";
      }
    }

    // Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
    document.getElementById("filter-btn").addEventListener("click", e => {
      e.preventDefault();
      loadQuestions();
    });

    loadQuestions();

    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ
    document.getElementById("add-question-btn").addEventListener("click", () => {
      window.location.href = `/dashboard/institute/classes/${classroomId}/exams/${examId}/add-question/`;
    });
    document.getElementById("edit-exam-btn").addEventListener("click", () => {
      window.location.href = `/dashboard/institute/classes/${classroomId}/exams/${examId}/edit/`;
    });
    document.getElementById("grade-questions-btn").addEventListener("click", () => {
      window.location.href = `/dashboard/institute/classes/${classroomId}/exams/${examId}/grade/`;
    });
    document.getElementById("exam-results-btn").addEventListener("click", () => {
      window.location.href = `/dashboard/institute/classes/${classroomId}/exams/${examId}/results/`;
    });
  </script>
</body>
</html>
