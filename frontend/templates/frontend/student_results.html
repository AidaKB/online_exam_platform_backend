{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نتایج آزمون</title>
  <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
</head>
<body>
  <header>
    <h1>نتایج آزمون</h1>
    <button class="btn-back" onclick="window.history.back()">⬅️ بازگشت</button>
  </header>

  <!-- فیلترها -->
  <section class="filters">
    <div class="filter-group">
      <input type="text" id="student-name-filter" placeholder="نام دانش‌آموز" class="form-input" />
      <input type="text" id="student-lastname-filter" placeholder="نام خانوادگی دانش‌آموز" class="form-input" />
      <input type="text" id="username-filter" placeholder="نام کاربری" class="form-input" />

      <select id="ordering" class="form-input">
        <option value="score">مرتب‌سازی بر اساس نمره ↑</option>
        <option value="-score">مرتب‌سازی بر اساس نمره ↓</option>
        <option value="exam__result_show_time">زمان نمایش نتیجه ↑</option>
        <option value="-exam__result_show_time">زمان نمایش نتیجه ↓</option>
        <option value="exam__title">عنوان آزمون ↑</option>
        <option value="-exam__title">عنوان آزمون ↓</option>
      </select>

      <button id="filter-btn" class="btn-primary">اعمال فیلتر</button>
    </div>
  </section>

  <div class="results-container" id="results-container">
    <p>در حال بارگذاری نتایج...</p>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const classroomId = pathParts[pathParts.indexOf("classes") + 1];
    const examId = pathParts[pathParts.indexOf("exams") + 1];

    const BASE_URL = `http://localhost:8000/api/exam/user-exam-results/`;
    const container = document.getElementById("results-container");

    function getScoreColor(score, maxScore) {
        const percent = (score / maxScore) * 100;
        if (percent >= 75) return "score-color-1"; // آبی
        if (percent >= 50) return "score-color-2"; // زرد
        if (percent >= 25) return "score-color-3"; // خاکستری روشن
        return "score-color-4";                   // خاکستری تیره
    }

    function buildApiUrl() {
        const params = new URLSearchParams();
        params.append("exam", examId);

        const studentFirst = document.getElementById("student-name-filter").value.trim();
        const studentLast = document.getElementById("student-lastname-filter").value.trim();
        const username = document.getElementById("username-filter").value.trim();
        const ordering = document.getElementById("ordering").value;

        // چون ویو SearchFilter داره، ما باید سرچ کلی بزنیم
        let searchTerms = [];
        if (studentFirst) searchTerms.push(studentFirst);
        if (studentLast) searchTerms.push(studentLast);
        if (username) searchTerms.push(username);

        if (searchTerms.length > 0) {
          params.append("search", searchTerms.join(" "));
        }

        if (ordering) params.append("ordering", ordering);

        return BASE_URL + "?" + params.toString();
    }


    async function loadResults() {
        try {
            const url = buildApiUrl();
            const resp = await fetch(url, { headers: { "Authorization": `Token ${token}` } });
            if (!resp.ok) throw new Error("خطا در دریافت نتایج");

            const data = await resp.json();
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = "<p>هیچ نتیجه‌ای برای این آزمون ثبت نشده است.</p>";
                return;
            }

            const maxScore = Math.max(...data.map(r => r.score)) || 1;

            for (const result of data) {
                const studentName = `${result.user.account.first_name || ""} ${result.user.account.last_name || ""}`.trim() || "دانش‌آموز ناشناس";

                const div = document.createElement("div");
                div.className = "result-card clickable-card";
                div.innerHTML = `
                    <span class="result-name">${studentName}</span>
                    <span class="result-score ${getScoreColor(result.score, maxScore)}">${result.score}</span>
                `;
                div.addEventListener("click", () => {
                window.location.href = `/dashboard/${window.location.pathname.split('/')[2]}/classes/${classroomId}/exams/${examId}/student-results/${result.user.id}/`;
                });
                container.appendChild(div);
            }

        } catch (err) {
            container.innerHTML = `<p style="color:red;">${err.message}</p>`;
        }
    }

    document.getElementById("filter-btn").addEventListener("click", e => {
      e.preventDefault();
      loadResults();
    });

    loadResults();
  </script>
</body>
</html>
