{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نتایج آزمون</title>
  <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
</head>
<body>
  <header>
    <h1>نتایج آزمون</h1>
    <button class="btn-back" onclick="window.history.back()">⬅️ بازگشت</button>
  </header>

  <div class="results-container" id="results-container">
    <p>در حال بارگذاری نتایج...</p>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const classroomId = pathParts[pathParts.indexOf("classes") + 1];
    const examId = pathParts[pathParts.indexOf("exams") + 1];

    const RESULTS_API = `http://localhost:8000/api/exam/user-exam-results/?exam=${examId}`;
    const container = document.getElementById("results-container");

    function getScoreColor(score, maxScore) {
        const percent = (score / maxScore) * 100;
        if (percent >= 75) return "score-color-1"; // آبی
        if (percent >= 50) return "score-color-2"; // زرد
        if (percent >= 25) return "score-color-3"; // خاکستری روشن
        return "score-color-4";                   // خاکستری تیره
    }

    async function loadResults() {
        try {
            const resp = await fetch(RESULTS_API, { headers: { "Authorization": `Token ${token}` } });
            if (!resp.ok) throw new Error("خطا در دریافت نتایج");

            const data = await resp.json();
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = "<p>هیچ نتیجه‌ای برای این آزمون ثبت نشده است.</p>";
                return;
            }

            const maxScore = Math.max(...data.map(r => r.score)) || 1;

            for (const result of data) {
                const studentName = `${result.user.account.first_name || ""} ${result.user.account.last_name || ""}`.trim() || "دانش‌آموز ناشناس";

                const div = document.createElement("div");
                div.className = "result-card clickable-card";
                div.innerHTML = `
                    <span class="result-name">${studentName}</span>
                    <span class="result-score ${getScoreColor(result.score, maxScore)}">${result.score}</span>
                `;
                div.addEventListener("click", () => {
                    window.location.href = `/dashboard/institute/classes/${classroomId}/exams/${examId}/student-results/${result.user.id}/`;
                });
                container.appendChild(div);
            }

        } catch (err) {
            container.innerHTML = `<p style="color:red;">${err.message}</p>`;
        }
    }

    loadResults();
  </script>
</body>
</html>
