{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>افزودن سوال</title>
  <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}">
</head>
<body>
  <!-- هدر صفحه -->
  <header class="header">
    <h1>افزودن سوال</h1>
    <button class="btn-back" onclick="window.history.back()">⬅️ بازگشت</button>
  </header>

  <!-- فرم سوال داخل کارت -->
  <div class="exam-card question-form">
    <h2>فرم افزودن سوال جدید</h2>

    <div class="form-grid">
      <label for="text">متن سوال:</label>
      <textarea id="text" rows="3" class="form-control"></textarea>

      <label for="question_type">نوع سوال:</label>
      <select id="question_type" class="form-control">
        <option value="MultipleChoice">چندگزینه‌ای</option>
        <option value="TrueFalse">درست/نادرست</option>
        <option value="Descriptive">تشریحی</option>
      </select>

      <label for="score">نمره سوال:</label>
      <input type="number" id="score" class="form-control" min="1" value="1">
    </div>

    <!-- بخش گزینه‌ها -->
    <div class="options-container" id="options-container" style="display:none;">
      <h4>گزینه‌ها</h4>
      <div id="option-list"></div>
      <button type="button" class="btn btn-primary" id="add-option-btn">افزودن گزینه</button>
    </div>

    <button type="button" class="btn btn-primary full-width" id="submit-btn">ذخیره سوال</button>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const classroomId = pathParts[pathParts.indexOf("classes") + 1];
    const examId = pathParts[pathParts.indexOf("exams") + 1];
    const BASE_API_URL = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/`;

    const questionTypeSelect = document.getElementById("question_type");
    const optionsContainer = document.getElementById("options-container");
    const optionList = document.getElementById("option-list");
    const addOptionBtn = document.getElementById("add-option-btn");

    // نمایش یا مخفی کردن بخش گزینه‌ها
    function updateOptionsVisibility() {
      if (questionTypeSelect.value === "Descriptive") {
        optionsContainer.style.display = "none";
        optionList.innerHTML = "";
      } else {
        optionsContainer.style.display = "block";
      }
    }

    questionTypeSelect.addEventListener("change", updateOptionsVisibility);

    // افزودن گزینه جدید
    function createOptionItem() {
      const div = document.createElement("div");
      div.className = "option-item";
      div.innerHTML = `
        <input type="text" placeholder="متن گزینه" class="form-control">
        <label>
          صحیح
          <input type="checkbox" class="is-correct">
        </label>
        <button type="button" class="btn btn-danger btn-remove-option">❌</button>
      `;
      div.querySelector(".btn-remove-option").addEventListener("click", () => div.remove());
      optionList.appendChild(div);
    }

    addOptionBtn.addEventListener("click", createOptionItem);

    // ذخیره سوال و سپس گزینه‌ها
    async function createQuestion() {
      const text = document.getElementById("text").value.trim();
      const question_type = questionTypeSelect.value;
      const score = parseInt(document.getElementById("score").value) || 1;

      if (!text) { alert("متن سوال را وارد کنید"); return; }

      // ابتدا ایجاد سوال
      let payload = { text, question_type, score };
      let questionId;
      try {
        const response = await fetch(BASE_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Token ${token}`
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error("خطا در ذخیره سوال");
        const data = await response.json();
        questionId = data.id;
      } catch (err) {
        alert(err.message);
        return;
      }

        // سپس ایجاد گزینه‌ها
        if (question_type !== "Descriptive") {
          const optionPromises = [];
          optionList.querySelectorAll(".option-item").forEach(item => {
            const optionText = item.querySelector("input[type=text]").value.trim();
            const is_correct = item.querySelector(".is-correct").checked;
            if(optionText) {
              const optionPayload = {
                text: optionText,
                is_correct,
                question_id: questionId
              };
              const url = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/questions/${questionId}/options/`;
              optionPromises.push(fetch(url, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Token ${token}`
                },
                body: JSON.stringify(optionPayload)
              }));
            }
          });

          try {
            await Promise.all(optionPromises);
          } catch (err) {
            alert("ذخیره گزینه‌ها با خطا مواجه شد: " + err.message);
            return;
          }
        }

      alert("سوال و گزینه‌ها با موفقیت اضافه شدند");
        const userType = window.location.pathname.split('/')[2];
        {#window.location.href = `/dashboard/${userType}/classes/${classroomId}/exams/${examId}/questions/`;#}
    }

    document.getElementById("submit-btn").addEventListener("click", createQuestion);

    // مقداردهی اولیه
    updateOptionsVisibility();
  </script>
</body>
</html>
