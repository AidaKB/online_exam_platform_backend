{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ú©Ù„Ø§Ø³</title>
    <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
</head>
<body>

<header>
    <h1>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ú©Ù„Ø§Ø³</h1>
    <button class="btn-back" id="back-btn">ğŸ”™ Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ú©Ù„Ø§Ø³</button>
</header>

<div class="top-buttons">
    <button id="add-student-btn" class="btn-primary">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
</div>

<!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
<section class="filters">
    <div class="filter-group">
        <input type="text" id="student_name-filter" placeholder="Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²" class="form-input" />
        <input type="text" id="student_last_name-filter" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²" class="form-input" />

        <select id="ordering" class="form-input">
            <option value="classroom__name">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ù„Ø§Ø³ â†‘</option>
            <option value="-classroom__name">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ù„Ø§Ø³ â†“</option>
            <option value="student__account__first_name">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² â†‘</option>
            <option value="-student__account__first_name">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² â†“</option>
            <option value="student__account__last_name">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² â†‘</option>
            <option value="-student__account__last_name">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² â†“</option>
        </select>

        <button id="filter-btn" class="btn-primary">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
    </div>
</section>

<!-- Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† -->
<section class="student-list" id="student-list">
    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†...</p>
</section>

<script>
const token = localStorage.getItem('token');
const classroomId = window.location.pathname.split('/').filter(Boolean).slice(-2, -1)[0];
const BASE_URL = `http://localhost:8000/api/exam/students-classrooms/`;

document.getElementById("back-btn").addEventListener("click", () => {
    window.location.href = `/dashboard/institute/classes/${classroomId}/`;
});

document.getElementById("add-student-btn").addEventListener("click", () => {
    window.location.href = `/dashboard/institute/classes/${classroomId}/students/add/`;
});

// Ø³Ø§Ø®Øª URL API Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§
function buildApiUrl() {
    const params = new URLSearchParams();
    params.append("classroom", classroomId);

    const student_name = document.getElementById("student_name-filter").value.trim();
    const student_last_name = document.getElementById("student_last_name-filter").value.trim();
    const ordering = document.getElementById("ordering").value;

    if (student_name) params.append("student_name", student_name);
    if (student_last_name) params.append("student_last_name", student_last_name);
    if (ordering) params.append("ordering", ordering);

    return BASE_URL + '?' + params.toString();
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
async function loadStudents() {
    try {
        const url = buildApiUrl();
        const res = await fetch(url, {
            headers: { "Authorization": `Token ${token}` }
        });
        if (!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†");
        const data = await res.json();
        const container = document.getElementById("student-list");
        container.innerHTML = "";

        if (data.length === 0) {
            container.innerHTML = "<p>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>";
            return;
        }

        data.forEach(item => {
            const div = document.createElement("div");
            div.className = "student-card";

            div.innerHTML = `
                <span class="student-name">${item.student}</span>
                <button class="btn-danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            `;

            div.querySelector(".btn-danger").addEventListener("click", async () => {
                if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ${item.student} Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ`)) return;
                try {
                    const delRes = await fetch(`http://localhost:8000/api/exam/students-classrooms/${item.id}/`, {
                        method: "DELETE",
                        headers: { "Authorization": `Token ${token}` }
                    });
                    if (!delRes.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²");
                    loadStudents();
                } catch (err) {
                    alert(err.message);
                }
            });

            container.appendChild(div);
        });

    } catch (err) {
        document.getElementById("student-list").innerHTML = `<p style="color:red;">${err.message}</p>`;
    }
}

document.getElementById("filter-btn").addEventListener("click", e => {
    e.preventDefault();
    loadStudents();
});

// Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
loadStudents();
</script>

</body>
</html>
