{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>بازخوردهای آزمون</title>
  <link rel="stylesheet" href="{% static 'frontend/css/style.css' %}" />
</head>
<body>
  <header>
    <h1 id="exam-title">بازخوردهای آزمون</h1>
    <button class="btn-back" onclick="window.history.back()">⬅️ بازگشت</button>
  </header>

  <!-- فیلترها و جستجو -->
  <section class="filters">
    <div class="filter-group">
      <input type="text" id="student-name-filter" placeholder="نام یا نام خانوادگی دانش‌آموز" class="form-input" />
      <input type="text" id="student-code-filter" placeholder="کد ملی دانش‌آموز" class="form-input" />
      <select id="ordering" class="form-input">
        <option value="user__account__last_name">مرتب‌سازی بر اساس نام خانوادگی ↑</option>
        <option value="-user__account__last_name">مرتب‌سازی بر اساس نام خانوادگی ↓</option>
        <option value="user__account__first_name">مرتب‌سازی بر اساس نام ↑</option>
        <option value="-user__account__first_name">مرتب‌سازی بر اساس نام ↓</option>
      </select>
      <button id="filter-btn" class="btn-primary">اعمال فیلتر</button>
    </div>
  </section>

  <!-- لیست بازخوردها -->
  <section id="feedback-list">
    <div class="questions-container">
      <p>در حال بارگذاری بازخوردها...</p>
    </div>
  </section>

  <script>
    const token = localStorage.getItem("token");
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const classroomId = pathParts[pathParts.indexOf("classes") + 1];
    const examId = pathParts[pathParts.indexOf("exams") + 1];
    const basePath = pathParts[2]; // user_type
    const FEEDBACK_API_URL = `http://localhost:8000/api/exam/feedbackes/`;
    const EXAM_API_URL = `http://localhost:8000/api/exam/classrooms/${classroomId}/exams/${examId}/`;

    const container = document.querySelector("#feedback-list .questions-container");
    const examTitleHeader = document.getElementById("exam-title");

    // گرفتن عنوان آزمون و نمایش در هدر و تایتل
    async function loadExamTitle() {
      try {
        const resp = await fetch(EXAM_API_URL, { headers: { "Authorization": `Token ${token}` } });
        if (!resp.ok) throw new Error("خطا در دریافت اطلاعات آزمون");
        const exam = await resp.json();
        examTitleHeader.textContent = `بازخوردهای آزمون - ${exam.title}`;
        document.title = `بازخوردهای آزمون - ${exam.title}`;
      } catch (err) {
        console.error(err);
      }
    }

    // ساخت URL با فیلترها و ترتیب + فیلتر بر اساس آزمون فعلی
    function buildApiUrl() {
      const params = new URLSearchParams();
      const name = document.getElementById("student-name-filter").value.trim();
      const code = document.getElementById("student-code-filter").value.trim();
      const ordering = document.getElementById("ordering").value;

      if (name) {
        params.append("student_first_name", name);
        params.append("student_last_name", name);
      }
      if (code) params.append("student_national_code", code);

      params.append("exam", examId); // فقط بازخوردهای آزمون فعلی
      if (ordering) params.append("ordering", ordering);

      return FEEDBACK_API_URL + "?" + params.toString();
    }

    async function loadFeedbacks() {
      try {
        const url = buildApiUrl();
        const resp = await fetch(url, { headers: { "Authorization": `Token ${token}` } });
        if (!resp.ok) throw new Error("خطا در دریافت بازخوردها");

        const data = await resp.json();
        container.innerHTML = "";

        if (data.length === 0) {
          container.innerHTML = "<p>هیچ بازخوردی یافت نشد.</p>";
          return;
        }

        data.forEach(fb => {
          const div = document.createElement("div");
          div.className = "question-card clickable-card";
          div.innerHTML = `
            <h3>${fb.user.account.first_name} ${fb.user.account.last_name} (${fb.user.national_code})</h3>
            <p><strong>بازخورد:</strong> ${fb.text}</p>
          `;
          container.appendChild(div);
        });

      } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
      }
    }

    document.getElementById("filter-btn").addEventListener("click", e => {
      e.preventDefault();
      loadFeedbacks();
    });

    // بارگذاری اولیه
    loadExamTitle();
    loadFeedbacks();
  </script>
</body>
</html>
